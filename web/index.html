<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=BBH+Sans+Bartle&family=Fira+Sans:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
          rel="stylesheet">
    <meta content="Physball Game" property="og:title">
    <meta content="Physbal online game demo. Feel free to stop by and play Physball in your browser, or head to the download page and play the desktop vesion."
          property="og:description">
    <meta content="https://physball.app/" property="og:url">
    <meta content="#59b4dc" data-react-helmet="true" name="theme-color">
    <style>
        /* Styles for the loading screen */
        :root {
            --web-bg-color: #2b2c2f;
            --web-color: white;
        }

        * {
            margin: 0;
            padding: 0;
            border: 0;
        }

        html,
        body {
            width: 100%;
        }

        h1 {
            font-family: "BBH Sans Bartle", sans-serif;
            font-size: 32pt;
        }

        .center {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .center-column {
            width: 60%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: start;
            flex-shrink: 0;
        }

        .pre-content {
            width: 100%;
            padding-bottom: 20px;
        }

        .center-text {
            width: 100%;
            text-align: center;
        }

        body {
            background-color: var(--web-bg-color);
            color: var(--web-color);
        }

        canvas {
            outline: none;
            width: 100% !important;
            height: auto !important;
            aspect-ratio: 16 / 9;
        }

        a {
            color: deepskyblue;
            text-decoration: none;
        }

        a:visited {
            color: deepskyblue;
        }

        .spinner-holder {
            width: 100% !important;
            height: auto !important;
            aspect-ratio: 16 / 9;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .spinner {
            width: 128px;
            height: 128px;
            border: 10px solid transparent;
            border-bottom-color: #ececec;
            border-right-color: #b2b2b2;
            border-top-color: #787878;
            border-radius: 50%;
            box-sizing: border-box;
            animation: spin 1.5s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @media screen and (max-width: 1400px) {
            .center-column {
                width: 100%;
            }
        }
    </style>
    <title>Physball</title>
</head>

<body class="center">

<div class="center-column">
    <div class="pre-content">
        <h1 class="center-text">Physball Web Demo</h1>

        <div class="center-text">
            Note: web builds of Physball may be buggy and are missing features. Try the desktop versions if you
            encounter
            issues.

            Desktop versions are available at <a href="https://github.com/Kneelawk/physball/releases">https://github.com/Kneelawk/physball/releases</a>.
        </div>
    </div>

    <noscript>JavaScript support is required to run this app</noscript>
    <div id="loading-screen" class="spinner-holder">
        <span class="spinner"></span>
    </div>

    <canvas id="game"></canvas>
</div>

<script type="module">
    // Automatically restart the audio context after user interaction
    // Needs to be executed _before_ the game is loaded
    // Taken from https://developer.chrome.com/blog/web-audio-autoplay/#moving-forward
    (function () {
        // An array of all contexts to resume on the page
        const audioContextList = [];

        // An array of various user interaction events we should listen for
        const userInputEventNames = [
            "click",
            "contextmenu",
            "auxclick",
            "dblclick",
            "mousedown",
            "mouseup",
            "pointerup",
            "touchend",
            "keydown",
            "keyup",
        ];

        // A proxy object to intercept AudioContexts and
        // add them to the array for tracking and resuming later
        self.AudioContext = new Proxy(self.AudioContext, {
            construct(target, args) {
                const result = new target(...args);
                audioContextList.push(result);
                return result;
            },
        });

        // To resume all AudioContexts being tracked
        function resumeAllContexts(event) {
            let count = 0;

            audioContextList.forEach((context) => {
                if (context.state !== "running") {
                    context.resume();
                } else {
                    count++;
                }
            });

            // If all the AudioContexts have now resumed then we
            // unbind all the event listeners from the page to prevent
            // unnecessary resume attempts
            if (count == audioContextList.length) {
                userInputEventNames.forEach((eventName) => {
                    document.removeEventListener(eventName, resumeAllContexts);
                });
            }
        }

        // We bind the resume function for each user interaction
        // event on the page
        userInputEventNames.forEach((eventName) => {
            document.addEventListener(eventName, resumeAllContexts);
        });
    })();
</script>

<script type="module">
    // Starting the game

    // When this file is used as the default `index.html`, the CLI will automatically replace
    // `bevy_app.js` with the name of the generated JS entrypoint. If you copy this file and
    // customize it, you will need to manually change the name. For more information, please see
    // <https://thebevyflock.github.io/bevy_cli/cli/web/default-index-html.html>!
    import init from "./build/physball.js";

    // Hide loading screen when the game starts.
    const loading_screen = document.getElementById("loading-screen");

    init().catch((error) => {
        if (
            !error.message.startsWith(
                "Using exceptions for control flow, don't mind me. This isn't actually an error!"
            )
        ) {
            throw error;
        }
    }).then(() => {
        console.log("Game loaded.");
        loading_screen.style.display = "none";
    });
</script>

<script type="module">
    // Hide loading screen when the game starts.
    const loading_screen = document.getElementById("loading-screen");
    const observer = new MutationObserver((records) => {
        for (const record of records) {
            for (const addedNode of record.addedNodes) {
                if (addedNode instanceof HTMLCanvasElement) {
                    if (addedNode.innerText.trim().length === 0) {
                        // Add compatibility note
                        addedNode.innerText =
                            "Canvas support is required to run this app";
                    }

                    // A new canvas has been created, which means that the game has been loaded
                    // Hide the loading screen!
                    loading_screen.style.display = "none";
                    observer.disconnect();
                    return;
                }
            }
        }
    });

    observer.observe(document.body, {
        subtree: false,
        childList: true,
        attributes: false,
        characterData: false,
    });
</script>
</body>
</html>
